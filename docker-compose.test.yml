services:
  # PostgreSQL with ParadeDB extension (Test environment)
  postgres-test:
    image: paradedb/paradedb:latest
    container_name: conectasei_postgres_test
    environment:
      POSTGRES_DB: automasei_test
      POSTGRES_USER: automasei_test
      POSTGRES_PASSWORD: automasei_test_password
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5433:5432"  # Porta diferente para não conflitar com dev
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U automasei_test"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - conectasei_test_network

  # Firebase Emulator Suite
  firebase-emulator:
    image: node:20-alpine
    container_name: conectasei_firebase_emulator
    working_dir: /app
    command: >
      sh -c "npm install -g firebase-tools &&
             firebase emulators:start --project conectasei-test --only storage"
    environment:
      # Configurações do Firebase Emulator
      FIREBASE_STORAGE_EMULATOR_HOST: 0.0.0.0:9199
      GCLOUD_PROJECT: conectasei-test
    ports:
      - "9199:9199"  # Storage Emulator
      - "4000:4000"   # Emulator UI
    volumes:
      - ./tests/firebase:/app
      - firebase_emulator_data:/root/.cache/firebase/emulators
    networks:
      - conectasei_test_network
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:9199 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_test_data:
    driver: local
  firebase_emulator_data:
    driver: local

networks:
  conectasei_test_network:
    driver: bridge
