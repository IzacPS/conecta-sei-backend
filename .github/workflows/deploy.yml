# Deploy na branch master/main. O pipeline faz TUDO: builda imagem, copia compose,
# escreve .env e sobe os containers. Na máquina só precisa ter Docker instalado.
#
# Secrets: DATABASE_URL, DEPLOY_SSH_KEY, FIREBASE_CREDENTIALS, GHCR_TOKEN
# Variables: AUTH_DEV_MODE, DEPLOY_HOST, DEPLOY_USER, PAYMENT_PROVIDER
# Produção: + Secrets CONECTASEI_ENCRYPTION_KEY, FIREBASE_STORAGE_BUCKET

name: Build and Deploy

on:
  push:
    branches:
      - master
      - main

env:
  REGISTRY: ghcr.io
  DEPLOY_DIR: /opt/conecta-sei-backend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ github.repository }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: success()
    steps:
      - name: Checkout (pega docker-compose.prod.yml)
        uses: actions/checkout@v4
        with:
          sparse-checkout: docker-compose.prod.yml

      - name: Copia docker-compose.prod.yml pro servidor
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ vars.DEPLOY_HOST }}
          username: ${{ vars.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          source: docker-compose.prod.yml
          target: ${{ env.DEPLOY_DIR }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.DEPLOY_HOST }}
          username: ${{ vars.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          envs: GHCR_TOKEN,BACKEND_IMAGE,DATABASE_URL,FIREBASE_CREDENTIALS,FIREBASE_STORAGE_BUCKET,CONECTASEI_ENCRYPTION_KEY,AUTH_DEV_MODE,PAYMENT_PROVIDER,DEPLOY_DIR
          script: |
            set -e

            # Cria pasta se não existir
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"

            # Extrai POSTGRES_* do DATABASE_URL
            if [[ "$DATABASE_URL" =~ postgresql://([^:]+):([^@]+)@[^/]+/(.+) ]]; then
              PG_USER="${BASH_REMATCH[1]}"
              PG_PASS="${BASH_REMATCH[2]}"
              PG_DB="${BASH_REMATCH[3]}"
            else
              echo "DATABASE_URL inválida"; exit 1
            fi

            # Gera .env (o compose lê daqui)
            cat > .env <<EOF
            BACKEND_IMAGE=$BACKEND_IMAGE
            POSTGRES_USER=$PG_USER
            POSTGRES_PASSWORD=$PG_PASS
            POSTGRES_DB=$PG_DB
            FIREBASE_CREDENTIALS=$FIREBASE_CREDENTIALS
            FIREBASE_STORAGE_BUCKET=$FIREBASE_STORAGE_BUCKET
            CONECTASEI_ENCRYPTION_KEY=$CONECTASEI_ENCRYPTION_KEY
            AUTH_DEV_MODE=${AUTH_DEV_MODE:-false}
            PAYMENT_PROVIDER=${PAYMENT_PROVIDER:-manual}
            EOF

            # Remove espaços de indentação do heredoc
            sed -i 's/^[[:space:]]*//' .env

            # Login no GHCR e pull da imagem
            echo "$GHCR_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker pull "$BACKEND_IMAGE"

            # Sobe (ou atualiza) os containers
            docker compose -f docker-compose.prod.yml up -d --no-build
            docker image prune -f
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          BACKEND_IMAGE: ${{ env.REGISTRY }}/${{ github.repository }}:latest
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET || vars.FIREBASE_STORAGE_BUCKET }}
          CONECTASEI_ENCRYPTION_KEY: ${{ secrets.CONECTASEI_ENCRYPTION_KEY }}
          AUTH_DEV_MODE: ${{ vars.AUTH_DEV_MODE }}
          PAYMENT_PROVIDER: ${{ vars.PAYMENT_PROVIDER }}
          DEPLOY_DIR: ${{ env.DEPLOY_DIR }}
