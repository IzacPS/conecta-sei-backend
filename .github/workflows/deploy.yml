# Deploy na branch master. Mínimo (como nas imagens):
# - Secrets: DATABASE_URL, DEPLOY_SSH_KEY, FIREBASE_CREDENTIALS, GHCR_TOKEN
# - Variables: AUTH_DEV_MODE, DEPLOY_HOST, DEPLOY_USER, PAYMENT_PROVIDER
#
# Produção (recomendado) — adicione também:
# - Secrets: CONECTASEI_ENCRYPTION_KEY
# - (Secrets ou Variables): FIREBASE_STORAGE_BUCKET

name: Build and Deploy

on:
  push:
    branches:
      - master
      - main

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Image meta
        id: meta
        run: |
          echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "owner=${{ github.repository_owner }}" >> $GITHUB_OUTPUT
          echo "image=${{ env.REGISTRY }}/${{ github.repository }}:latest" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: success() && secrets.DEPLOY_SSH_KEY != ''
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.DEPLOY_HOST }}
          username: ${{ vars.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          envs: GHCR_TOKEN,BACKEND_IMAGE,DATABASE_URL,FIREBASE_CREDENTIALS,FIREBASE_STORAGE_BUCKET,CONECTASEI_ENCRYPTION_KEY,AUTH_DEV_MODE,PAYMENT_PROVIDER
          script: |
            set -e
            cd ~/conecta-sei-backend || { echo "Diretório ~/conecta-sei-backend não encontrado"; exit 1; }
            # Extrai POSTGRES_* do DATABASE_URL (postgresql://user:password@host:port/db)
            if [[ "$DATABASE_URL" =~ postgresql://([^:]+):([^@]+)@[^/]+/(.+) ]]; then
              POSTGRES_USER="${BASH_REMATCH[1]}"
              POSTGRES_PASSWORD="${BASH_REMATCH[2]}"
              POSTGRES_DB="${BASH_REMATCH[3]}"
            else
              POSTGRES_USER="automasei"
              POSTGRES_PASSWORD=""
              POSTGRES_DB="automasei"
            fi

            # Valida requisitos mínimos em produção (AUTH_DEV_MODE=false)
            if [ "${AUTH_DEV_MODE:-false}" != "true" ]; then
              if [ -z "${CONECTASEI_ENCRYPTION_KEY:-}" ]; then
                echo "Faltando CONECTASEI_ENCRYPTION_KEY (adicione como Secret)."
                exit 1
              fi
              if [ -z "${FIREBASE_STORAGE_BUCKET:-}" ]; then
                echo "Faltando FIREBASE_STORAGE_BUCKET (adicione como Secret ou Variable)."
                exit 1
              fi
              if [ -z "${FIREBASE_CREDENTIALS:-}" ]; then
                echo "Faltando FIREBASE_CREDENTIALS (adicione como Secret)."
                exit 1
              fi
              if [[ "${FIREBASE_CREDENTIALS}" == *$'\n'* ]]; then
                echo "FIREBASE_CREDENTIALS deve ser JSON em UMA linha (minificado)."
                exit 1
              fi
            fi
            {
              echo "POSTGRES_USER=$POSTGRES_USER"
              echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD"
              echo "POSTGRES_DB=$POSTGRES_DB"
              echo "FIREBASE_CREDENTIALS=$FIREBASE_CREDENTIALS"
              echo "FIREBASE_STORAGE_BUCKET=$FIREBASE_STORAGE_BUCKET"
              echo "CONECTASEI_ENCRYPTION_KEY=$CONECTASEI_ENCRYPTION_KEY"
              echo "AUTH_DEV_MODE=${AUTH_DEV_MODE:-false}"
              echo "PAYMENT_PROVIDER=${PAYMENT_PROVIDER:-manual}"
            } > .env
            if [ -n "$GHCR_TOKEN" ]; then
              echo "$GHCR_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            fi
            docker pull $BACKEND_IMAGE
            docker compose -f docker-compose.prod.yml up -d --no-build
            docker image prune -f
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          BACKEND_IMAGE: ${{ env.REGISTRY }}/${{ github.repository }}:latest
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET || vars.FIREBASE_STORAGE_BUCKET }}
          CONECTASEI_ENCRYPTION_KEY: ${{ secrets.CONECTASEI_ENCRYPTION_KEY }}
          AUTH_DEV_MODE: ${{ vars.AUTH_DEV_MODE }}
          PAYMENT_PROVIDER: ${{ vars.PAYMENT_PROVIDER }}
